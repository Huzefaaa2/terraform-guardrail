name: Homebrew Tap Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check Homebrew secrets
        id: gate
        shell: bash
        run: |
          if [ -z "${{ secrets.HOMEBREW_TAP_REPO }}" ] || [ -z "${{ secrets.HOMEBREW_TAP_TOKEN }}" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Missing Homebrew secrets. Skipping publish."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi
      - uses: actions/checkout@v4
        if: ${{ steps.gate.outputs.skip != 'true' }}
      - uses: actions/setup-python@v5
        if: ${{ steps.gate.outputs.skip != 'true' }}
        with:
          python-version: "3.11"
      - name: Resolve PyPI sdist hash
        if: ${{ steps.gate.outputs.skip != 'true' }}
        id: pypi
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          export TAG
          SHA256=$(python - <<'PY'
          import json
          import os
          import time
          import urllib.request

          version = os.environ["TAG"]
          url = f"https://pypi.org/pypi/terraform-guardrail/{version}/json"
          for _ in range(30):
              try:
                  with urllib.request.urlopen(url) as r:
                      data = json.load(r)
                  sdists = [f for f in data.get("urls", []) if f.get("packagetype") == "sdist"]
                  if sdists:
                      print(sdists[0]["digests"]["sha256"])
                      raise SystemExit(0)
              except Exception:
                  time.sleep(10)
          raise SystemExit("Timed out waiting for PyPI sdist metadata")
          PY
          )
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
      - name: Build formula
        if: ${{ steps.gate.outputs.skip != 'true' }}
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          mkdir -p dist/packaging/homebrew
          sed "s/{{VERSION}}/${TAG}/g; s/{{SHA256}}/${{ steps.pypi.outputs.sha256 }}/g" \
            packaging/homebrew/terraform-guardrail.rb.in \
            > dist/packaging/homebrew/terraform-guardrail.rb
      - name: Checkout tap repository
        if: ${{ steps.gate.outputs.skip != 'true' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.HOMEBREW_TAP_REPO }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap
      - name: Update formula
        if: ${{ steps.gate.outputs.skip != 'true' }}
        run: |
          mkdir -p tap/Formula
          cp dist/packaging/homebrew/terraform-guardrail.rb tap/Formula/terraform-guardrail.rb
          cd tap
          git add Formula/terraform-guardrail.rb
          if git diff --cached --quiet; then
            echo "No formula changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "terraform-guardrail ${GITHUB_REF_NAME}"
          git push
