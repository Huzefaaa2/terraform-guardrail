name: Chocolatey Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 1.0.4)"
        required: false
        default: ""

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Check Chocolatey secret
        id: gate
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace("${{ secrets.CHOCO_API_KEY }}")) {
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Missing Chocolatey API key. Skipping publish."
          } else {
            "skip=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
      - uses: actions/checkout@v4
        if: ${{ steps.gate.outputs.skip != 'true' }}
      - name: Build Chocolatey package
        if: ${{ steps.gate.outputs.skip != 'true' }}
        shell: powershell
        run: |
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrWhiteSpace($version)) {
            $version = "${{ github.ref_name }}".TrimStart("v")
          }
          $dest = "dist/packaging/chocolatey"
          New-Item -ItemType Directory -Force -Path "$dest/tools" | Out-Null
          (Get-Content packaging/chocolatey/terraform-guardrail.nuspec.in) `
            -replace "{{VERSION}}", $version | `
            Set-Content "$dest/terraform-guardrail.nuspec"
          Copy-Item packaging/chocolatey/tools/chocolateyinstall.ps1 "$dest/tools/chocolateyinstall.ps1" -Force
          choco pack "$dest/terraform-guardrail.nuspec" --outputdirectory "$dest"
      - name: Publish to Chocolatey
        if: ${{ steps.gate.outputs.skip != 'true' }}
        shell: powershell
        run: |
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrWhiteSpace($version)) {
            $version = "${{ github.ref_name }}".TrimStart("v")
          }
          $package = "dist/packaging/chocolatey/terraform-guardrail.$version.nupkg"
          choco push $package --source https://push.chocolatey.org/ --api-key "${{ secrets.CHOCO_API_KEY }}"
