parameters:
  - name: path
    type: string
    default: "."
  - name: state
    type: string
    default: ""
  - name: schema
    type: boolean
    default: false
  - name: failOn
    type: string
    default: "medium"
  - name: policyBundle
    type: string
    default: ""
  - name: policyRegistry
    type: string
    default: ""
  - name: policyQuery
    type: string
    default: ""
  - name: pythonVersion
    type: string
    default: "3.11"
  - name: jsonReport
    type: string
    default: "guardrail-report.json"
  - name: sarifReport
    type: string
    default: "guardrail-report.sarif"
  - name: junitReport
    type: string
    default: "guardrail-report.junit.xml"
  - name: publishReports
    type: boolean
    default: true

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: ${{ parameters.pythonVersion }}

  - script: |
      python -m pip install --upgrade pip
      python -m pip install --upgrade terraform-guardrail
    displayName: "Install terraform-guardrail"

  - script: |
      set -euo pipefail
      args=""
      if [ "${{ parameters.schema }}" = "true" ]; then
        args="$args --schema"
      fi
      if [ -n "${{ parameters.state }}" ]; then
        args="$args --state ${{ parameters.state }}"
      fi
      if [ -n "${{ parameters.policyBundle }}" ]; then
        args="$args --policy-bundle ${{ parameters.policyBundle }}"
      fi
      if [ -n "${{ parameters.policyRegistry }}" ]; then
        args="$args --policy-registry ${{ parameters.policyRegistry }}"
      fi
      if [ -n "${{ parameters.policyQuery }}" ]; then
        args="$args --policy-query ${{ parameters.policyQuery }}"
      fi
      terraform-guardrail scan "${{ parameters.path }}" \
        --format pretty \
        --fail-on "${{ parameters.failOn }}" \
        $args

      terraform-guardrail scan "${{ parameters.path }}" \
        --format json \
        --fail-on "${{ parameters.failOn }}" \
        $args > "${{ parameters.jsonReport }}"

      python - <<'PY'
import json
import os
import xml.etree.ElementTree as ET

json_path = os.environ.get("JSON_REPORT", "guardrail-report.json")
sarif_path = os.environ.get("SARIF_REPORT", "guardrail-report.sarif")
junit_path = os.environ.get("JUNIT_REPORT", "guardrail-report.junit.xml")

with open(json_path, encoding="utf-8") as handle:
    report = json.load(handle)

def to_level(severity: str) -> str:
    if severity == "high":
        return "error"
    if severity == "medium":
        return "warning"
    return "note"

findings = report.get("findings", [])

results = []
rules = {}
for finding in findings:
    rule_id = finding.get("rule_id", "UNKNOWN")
    rules.setdefault(rule_id, {"id": rule_id, "name": rule_id})
    result = {
        "ruleId": rule_id,
        "level": to_level(finding.get("severity", "low")),
        "message": {"text": finding.get("message", "")},
    }
    path = finding.get("path")
    if path:
        result["locations"] = [{"physicalLocation": {"artifactLocation": {"uri": path}}}]
    results.append(result)

sarif = {
    "version": "2.1.0",
    "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
    "runs": [
        {
            "tool": {
                "driver": {
                    "name": "Terraform Guardrail MCP",
                    "informationUri": "https://github.com/Huzefaaa2/terraform-guardrail",
                    "rules": list(rules.values()),
                }
            },
            "results": results,
        }
    ],
}

with open(sarif_path, "w", encoding="utf-8") as handle:
    json.dump(sarif, handle, indent=2)

testsuite = ET.Element("testsuite", name="terraform-guardrail")
testsuite.set("tests", str(len(findings)))
failures = sum(1 for f in findings if f.get("severity") in {"high", "medium"})
skipped = sum(1 for f in findings if f.get("severity") == "low")
testsuite.set("failures", str(failures))
testsuite.set("skipped", str(skipped))

for finding in findings:
    rule_id = finding.get("rule_id", "UNKNOWN")
    message = finding.get("message", "")
    path = finding.get("path", "")
    testcase = ET.SubElement(testsuite, "testcase", classname=rule_id, name=message)
    detail = f"{message}"
    if path:
        detail = f"{message} ({path})"
    if finding.get("severity") == "low":
        ET.SubElement(testcase, "skipped", message=detail)
    else:
        failure = ET.SubElement(testcase, "failure", message=detail)
        failure.text = detail

tree = ET.ElementTree(testsuite)
tree.write(junit_path, encoding="utf-8", xml_declaration=True)
PY
    env:
      JSON_REPORT: ${{ parameters.jsonReport }}
      SARIF_REPORT: ${{ parameters.sarifReport }}
      JUNIT_REPORT: ${{ parameters.junitReport }}
    displayName: "Run Terraform Guardrail scan"

  - ${{ if eq(parameters.publishReports, true) }}:
      - task: PublishTestResults@2
        inputs:
          testResultsFormat: "JUnit"
          testResultsFiles: ${{ parameters.junitReport }}
          failTaskOnFailedTests: false
        condition: succeededOrFailed()

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: ${{ parameters.jsonReport }}
          ArtifactName: "guardrail-json"
        condition: succeededOrFailed()

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: ${{ parameters.sarifReport }}
          ArtifactName: "guardrail-sarif"
        condition: succeededOrFailed()
